# Возможные причины ошибки `Connection refused`

Ошибка `Bad_ConnectionRejected` с сообщением `Connection refused` при попытке подключиться к OPC UA эндпоинту чаще всего означает, что TCP-соединение не было принято удалённым узлом. Возможные причины:

1. **Сервер отключён или не запущен.** Клиент пытается открыть сокет к адресу `opc.tcp://172.29.40.158:30479`, но на порту никто не слушает. По умолчанию этот адрес подставляется из `application.yaml` (ключ `opc.providers[?].url` для симулятора) и может быть переопределён переменной окружения `SIM_URL`.
2. **Брандмауэр или политика безопасности.** Межсетевые фильтры могут блокировать входящие соединения на порт 30479, даже если сервер работает. Необходимо проверить правила firewall/iptables, security group и т.п.
3. **Сервер перегружен или достиг лимитов.** OPC-сервер может отклонять новые подключения при исчерпании пула сессий или превышении лимита клиентов. В таком случае нужно увеличить лимит или завершить лишние сессии.
4. **Неверная конфигурация адреса.** Возможна ошибка в IP, порте или имени хоста. Если адрес устарел или изменился, сервер будет недоступен, и соединение будет отклонено.
5. **Сервер работает, но слушает на другом интерфейсе.** Например, сервер привязан к localhost, а клиент подключается по внешнему IP. Нужно сверить bind-адрес сервера.
6. **Проблемы на уровне сети.** Сбои маршрутизации, VPN или NAT могут приводить к невозможности установить TCP-соединение.

Для диагностики следует проверить доступность хоста (ping, traceroute), порт (telnet, nc), состояние OPC UA сервера и сетевую конфигурацию. Логи сервера часто содержат дополнительные подсказки, почему соединение отклонено.

## Откуда берётся адрес `172.29.40.158:30479`

В конфигурации приложения указаны два OPC-провайдера: промышленный (`IOT`) и симулятор (`OPCUA`). Для симулятора в `src/main/resources/application.yaml` задан URL по умолчанию `opc.tcp://172.29.40.158:30479`. При запуске этот адрес берётся из свойства `opc.providers[?].url`; его можно переопределить, задав переменную окружения `SIM_URL` (например, `SIM_URL=opc.tcp://10.0.0.15:4840`). Если переменная не указана, клиент будет пытаться подключиться именно к `172.29.40.158:30479`.

## Настройка через `envOpcConfig`

Помимо одиночных переменных вроде `SIM_URL`, можно полностью заменить набор провайдеров, передав JSON-массив через `envOpcConfig`, например:

```json
[
  {"name":"IOT","url":"opc.tcp://opcua.datana.iiothub.ru:4841","type":"iothub","selector":"opc.tcp://opcua-server-","user":"datana","password":"***"},
  {"name":"OPCUA","url":"opc.tcp://172.29.40.158:31894","type":"simulator"}
]
```

Сервис использует этот список и при первичном старте, и во всех последующих попытках переподключения. Ранее планировщик здоровья при реконнекте обращался к значениям из `application.yaml`, из‑за чего после первой сессии клиент переходил на порт по умолчанию (`30479`). Теперь он повторно использует тот же список, что был загружен из `envOpcConfig`, поэтому повторные подключения идут на `opc.tcp://172.29.40.158:31894`.

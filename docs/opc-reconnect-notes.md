# OPC UA Reconnect Notes

## Root Cause in Previous Version
- Клиенты OPC UA пересоздавались после простоя, но новое соединение с сервером не устанавливалось сразу.
- Метод `ManagedSubscription.createAsync` требовал активной сессии, из-за чего создание подписки падало с `Bad_SessionClosed`.
- При попытке восстановления подписки она сохранялась под неправильным ключом окружения, поэтому дальнейшие попытки обращались к неверному клиенту.

## Что изменено в PR
- Сразу после создания `OpcUaClient` вызывается `connect(...)`, а при успехе клиент сохраняется в `clients` и удаляется из `failedEndpoints`.
- При ошибке соединение логируется и endpoint помещается в `failedEndpoints` для повторной попытки.
- Исправлена повторная регистрация подписки: теперь она кладётся в таблицу `subscriptions` под текущим `env`.

## Почему это решает проблему
- Клиент входит в активную сессию до создания подписок, поэтому `ManagedSubscription.createAsync` выполняется успешно.
- Удаление endpoint из `failedEndpoints` исключает лишние попытки переподключения к уже восстановленному серверу.
- Корректное хранение подписок гарантирует, что повторные подписки и операции отрабатывают на правильном окружении.
